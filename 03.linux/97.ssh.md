# 97 | SSH

本文件基于你以往实际部署、调试与安全加固场景中总结的 SSH 公钥免密登录配置经验，特别强调权限要求与常见错误警告。

> ⚠️ 注意：部分命令虽基础，但其**注释极为关键**，包含多次部署与排障经验，请**勿删减注释内容**。

---

## 🔐 场景说明

- 在多台服务器之间实现免密互信（CI/CD、脚本远程拉取）
- 禁用密码登录以增强安全性（拒绝暴力破解）
- 手动或自动分发 `authorized_keys` 公钥文件到远程机器

---

## 🚀 步骤一：本地生成密钥对（客户端）

```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

> 默认生成：
>
> - `~/.ssh/id_rsa` 私钥（必须保密）
> - `~/.ssh/id_rsa.pub` 公钥（用于复制到远程）

---

## 🚀 步骤二：将公钥传输至目标主机

```bash
ssh-copy-id user@remote_ip
```

或者手动添加：

```bash
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
```

---

## 📂 权限配置要求（极易出错！）

```bash
chmod 700 ~/.ssh                    # 目录必须为 700
chmod 600 ~/.ssh/authorized_keys   # 公钥文件必须为 600
chown -R user:user ~/.ssh          # 权限归属必须是目标用户
```

> 🚨 如果权限不对，SSH 将直接忽略该文件！登录会失败且日志中无明显提示！

---

## 🧪 常见排错操作

```bash
# 查看 SSH 登录失败原因
journalctl -xe | grep sshd

# 手动连接查看提示
ssh -v user@remote_ip
```

---

## 🔧 服务端配置建议 `/etc/ssh/sshd_config`

```conf
PubkeyAuthentication yes
AuthorizedKeysFile .ssh/authorized_keys
PasswordAuthentication no       # 禁用密码登录（配合免密）
PermitRootLogin no              # 禁止 root 远程登录
```

修改后重启 SSH 服务：

```bash
systemctl restart ssh
```

---

## 🛡️ 安全建议（来自真实场景经验）

- **不要给 root 配置 authorized_keys**，应使用普通用户 + sudo 提权
- **建议搭配 Fail2Ban 使用**，防止爆破行为
- **公钥统一收敛管理**（如配置中心 / 运维平台 / GitHub Deploy Keys）
- 避免使用 `sshpass` 明文密码推送，优先使用公钥认证

---

## 🧠 历史注释说明

- `chmod 600 ~/.ssh/authorized_keys` 曾因疏忽设置为 644 导致多次“SSH 登录无响应”问题
- `cat ~/.ssh/id_rsa.pub >> authorized_keys` 用于某次非交互式配置 CI 节点免密登录
- `chown` 失败导致文件归属不一致，导致 sshd 拒绝载入密钥（此类问题曾排查超过 2 小时）
- `ssh -v` 是你历史上最常用的“最后排错手段”

---

> 📁 本文件建议作为 SSH 登录与远程运维策略核心文档长期维护。
